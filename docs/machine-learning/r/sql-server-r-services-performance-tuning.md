---
title: R 的性能优化
description: 本文介绍 R Services 的性能优化。
ms.prod: sql
ms.technology: machine-learning-services
ms.date: 04/15/2018
ms.topic: how-to
author: dphansen
ms.author: davidph
ms.custom: seo-lt-2019
monikerRange: '>=sql-server-2016||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: cedb8cd13db6c8d27b987c60881093caa91af50a
ms.sourcegitcommit: 9b41725d6db9957dd7928a3620fe4db41eb51c6e
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/13/2020
ms.locfileid: "88180454"
---
# <a name="performance-tuning-for-r-in-sql-server"></a>SQL Server 中 R 的性能优化
[!INCLUDE [SQL Server 2016 and later](../../includes/applies-to-version/sqlserver2016.md)]

本文是四篇系列文章中的第一篇文章，这些文章基于两个案例研究介绍 R Services 的性能优化：

- 产品开发团队为验证 R 解决方案的性能配置文件而执行的性能测试

- Microsoft 数据科学团队针对客户经常要求的特定机器学习场景进行性能优化。

本系列的目的是提供有关在 SQL Server 中运行 R 作业最有用的性能优化技术类型的指导。

+ 本主题（第一篇文章）概述了对数据科学任务进行优化时的体系结构和一些常见问题。
+ 第二篇文章介绍了具体的硬件和 SQL Server 优化。
+ 第三篇文章介绍 R 代码中的优化和实现操作化的资源。
+ 第四篇文章详细介绍了测试方法，并报告了结果和结论。

**适用于：** SQL Server 2016 R Services、SQL Server 机器学习服务

## <a name="performance-goals-and-targeted-scenarios"></a>性能目标和目标场景

R Services 功能在 SQL Server 2016 中引入，支持由 SQL Server 执行 R 脚本。 使用此功能时，R 运行时在独立于数据库引擎的进程中运行，但使用与 SQL server 交互的服务器资源和服务（如受信任的启动板）与数据库引擎安全地交换数据。

在 SQL Server 2017 中，宣布支持使用相同的体系结构运行 Python 脚本（将来还提供其他语言支持）。

随着支持的版本和语言的增加，数据库管理员和数据库架构师必须意识到由于机器学习作业而导致资源争用的可能性，并且能够配置服务器以支持新的工作负载，这一点非常重要。 尽管让分析贴近数据会消除不安全的数据移动，但它也将分析工作负载从数据科学家的笔记本电脑转移回了托管数据的服务器上。

机器学习的性能优化显然不是所有情况都适用的提议。 以下常见任务可能具有大不相同的性能配置文件：

- 定型任务：创建和定型回归模型与定型神经网络
- 使用 R 的特征工程与使用 T-SQL 的特征提取
- 单行或小批量评分与使用表格输入的大批量评分
- 在 R 中执行评分与在存储过程中将模型部署到 SQL Server 的生产环境中
- 修改 R 代码以最大程度地减少数据传输或删除成本高昂的数据转换
- 启用模型的自动测试和重新定型

因为优化技术的选择取决于哪个任务对应用程序或用例至关重要，所以案例研究既包括一般性能提示，也包括如何针对特定场景（即批量评分的优化）进行优化的指导。

+ **SQL Server 中的各个优化选项**

    在第一个性能案例研究中，使用单一类型的模型在单个数据集上运行多个测试。 RevoscaleR 中的 rxLinMod 算法用于生成模型并从中创建分数，但代码和基础数据表会进行系统地更改，以测试每个更改的影响。

    例如，在一次测试运行中，对 R 代码进行了更改，这样就可以在使用转换函数的特征工程与预先计算功能，然后从表中加载特征之间进行比较。 在另一次测试中，比较了使用标准索引表与使用具有不同类型压缩或新索引类型的表中数据进行模型定型的性能。

+ **针对特定大容量评分场景的优化**

    第二个案例研究中的机器学习任务包括处理向多个职位提交的大量简历，并为每个工作职位找到最佳候选人。 机器学习模型本身被归结为一个二元分类问题：它将简历和工作描述作为输入，并为每个简历-工作对生成概率。 由于目标是找出最佳匹配项，因此使用用户定义的概率阈值来进一步筛选，仅获取良好的匹配项。

    对于此解决方案，主要目标是在评分过程中实现低延迟。 然而，即使在评分过程中，此任务的计算成本也很高，因为每份新工作都必须在合理的期限内与数百万份简历相匹配。 此外，该特征工程步骤每份简历或工作会产生 2000 多个特征，这是一个显著的性能瓶颈。

我们建议你查看第一个案例研究中的所有结果，确定适用于你的解决方案的技术并权衡其潜在影响。

然后，查看评分优化案例研究的结果，了解作者如何应用不同的技术并优化服务器以支持特定的工作负载。

## <a name="performance-optimization-process"></a>性能优化进程

配置和性能优化需要创建一个坚实的基础，在此基础上对针对特定工作负载设计的优化进行分层：

- 选择适当的服务器以托管分析。 通常，首选报表辅助服务器、数据仓库或已经用于其他报表或分析的其他服务器。 但是，在混合事务分析处理 (HTAP) 解决方案中，可以将操作数据用作 R 的输入以实现快速评分。

- 配置 SQL Server 实例，以在适当的级别平衡数据库引擎操作和 R 或 Python 脚本的执行情况。 这可能包括更改 SQL Server 针对内存和 CPU 使用率、NUMA 和处理器关联设置以及创建资源组的默认设置。

- 优化服务器计算机以支持高效使用外部脚本。 这可能包括增加用于外部脚本执行的帐户数，启用包管理和将用户分配到相关的安全角色。

- 在 SQL Server 中应用特定于数据存储和传输的优化，包括索引和统计策略、查询设计和查询优化，以及用于机器学习的表的设计。 还可以分析数据源和数据传输方法，或修改 ETL 进程以优化特征提取。

- 优化分析模型，避免效率低下。 可能的优化范围取决于 R 代码的复杂性以及所使用的包和数据。 主要任务包括消除成本高昂的数据转换，或将数据准备或特征工程任务从 R 或 Python 卸载到 ETL 进程或 SQL 中。 还可以重构脚本，消除内嵌包安装，将 R 代码划分为单独的过程进行定型、评分和评估，或简化代码以使其作为存储过程更有效地工作。

## <a name="articles-in-this-series"></a>本系列文章

+ [SQL Server 中 R 的性能优化 - 硬件](../r/sql-server-configuration-r-services.md)

    提供有关配置安装了 [!INCLUDE[ssNoVersion_md](../../includes/ssnoversion-md.md)] 的硬件和配置 SQL Server 实例以更好地支持外部脚本的指南。 这对数据库管理员特别有用  。

+ [SQL Server 中的性能优化 - 代码和数据优化](../r/r-and-data-optimization-r-services.md)

    提供有关如何优化外部脚本以避免已知问题的具体提示。 这对数据科学家最有用  。

    > [!NOTE]
    > 虽然本部分中的很多信息通常适用于 R，但是有些信息专用于 RevoScaleR 分析函数。 未提供 revoscalepy 和其他支持的 Python 库的详细性能指南  。
    >

+ [SQL Server 中 R 的性能优化 - 方法和结果](../r/performance-case-study-r-services.md)

    总结了两个案例研究中使用的数据、性能测试方式以及优化对结果的影响。
